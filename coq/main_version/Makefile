WARN_MSG = "(* !!! WARNING: AUTO GENERATED. DO NOT MODIFY !!! *)\n"

OTT_LOC    = ../../spec

## Name of the submakefile generated by coq_makefile
COQMKFILENAME=CoqSrc.mk

LIBNAME="Top"

SYNTAX=syntax
TARGET=rules
DUNS=dunfield

FILES     = $(SYNTAX)_ott $(TARGET)_inf $(TARGET)_inf2
VFILES   = $(foreach i, $(FILES), $(i).v)
VOFILES  = $(foreach i, $(FILES), $(i).vo)

.SECONDARY: $(VFILES)

all: coq

quick:  $(COQMKFILENAME) $(VFILES)
	@$(MAKE) -f CoqSrc.mk quick

coq: $(COQMKFILENAME) $(VFILES)
	@$(MAKE) -f CoqSrc.mk

%.vo: %.v
	@$(MAKE) -f CoqSrc.mk $*.vo


$(SYNTAX)_ott.v: $(OTT_LOC)/main_version.ott $(OTT_LOC)/dunfield.ott $(OTT_LOC)/icfp.ott $(OTT_LOC)/embeded_def.v
	ott -i $(OTT_LOC)/main_version.ott -i $(OTT_LOC)/dunfield.ott -i $(OTT_LOC)/icfp.ott -o $(SYNTAX)_ott.v -coq_lngen true -coq_expand_list_types true
	@if grep '<<no parses (' $@ >/dev/null 2>&1 && \
	[ -z "$(DONTSTOP)" ]; then \
		echo; \
	echo "***** OTT PARSE ERROR(S) *****"; \
		grep -n '<<no parses (' $@; \
		$(RM) $@; \
		exit 1; \
	fi >&2
	@echo "coq embeded code inserted to $(SYNTAX)_ott.v"
	sed -i '/(\* defns Typing \*)/ r $(OTT_LOC)/embeded_def.v' $(SYNTAX)_ott.v


$(TARGET)_inf.v: $(OTT_LOC)/main_version.ott
	lngen --coq $(TARGET)_inf.v --coq-ott $(SYNTAX)_ott $(OTT_LOC)/main_version.ott

$(TARGET)_inf2.v: $(OTT_LOC)/$(DUNS).ott
	@echo "metavariables definition are uncommented in $(OTT_LOC)/$(DUNS)2.ott to use lngen"
	sed 's/^%//' $(OTT_LOC)/$(DUNS).ott > $(OTT_LOC)/$(DUNS)2.ott
	lngen --coq $(TARGET)_inf2.v --coq-ott $(SYNTAX)_ott $(OTT_LOC)/$(DUNS)2.ott
	rm $(OTT_LOC)/$(DUNS)2.ott
	@echo "$(OTT_LOC)/$(DUNS)2.ott deleted"

$(COQMKFILENAME): Makefile $(SYNTAX)_ott.v $(TARGET)_inf.v $(TARGET)_inf2.v
	{ echo "-R . $(LIBNAME)" ; ls *.v ; } > _CoqProject && coq_makefile -arg '-w -variable-collision,-meta-collision,-require-in-module' -f _CoqProject -o $(COQMKFILENAME)


coqclean:
	rm -f .*.d *.conf .*.aux *.v-e *.v.d *.vo *.vos *.vok *.glob $(VOFILES) $(COQMKFILENAME)

ottclean:
	rm -f $(SYNTAX)_ott.v $(TARGET)_inf.v $(TARGET)_inf2.v

clean: coqclean
